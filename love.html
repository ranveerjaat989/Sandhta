<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yes! ðŸ’˜</title>
  <link rel="stylesheet" href="style-yes.css">
</head>
<body>
  <main class="page">
    <div class="card">
      <div class="hearts" aria-hidden="true"></div>
      <h1>YAY â€” You said YES! ðŸŽ‰</h1>
      <p class="message">My heart is doing a happy dance â€” thank you for being mine! Let's make every day adorable together. ðŸŒ¸ðŸ’–</p>
      <p id="proposalNote" class="tiny">(You made my whole year â€” can't wait to spoil you!)</p>
      <div style="margin-top:12px;display:flex;gap:.6rem;align-items:center;justify-content:center;flex-wrap:wrap">
        <button id="notifyBtn" class="btn" style="display:none;background:#ffdfe9;border:1px solid #ffb6d1;color:#8b4f66;padding:.55rem .9rem">Notify proposer ðŸ’Œ</button>
        <a class="btn home" href="index.html">Back to start ðŸ’Œ</a>
      </div>
    </div>
  </main>

  <script src="params.js"></script>
  <script>
    // gentle sparkle on load and personalize the message if `porposal-by` present
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelector('.card').classList.add('celebrate');
      try{
        const name = window.__proposal && window.__proposal.getName && window.__proposal.getName();
        const note = document.getElementById('proposalNote');
        if(name && note){
          note.textContent = name + " proposed to you â€” you said YES! ðŸ’–";
        }

        // show notify button if an email param exists
        const params = new URLSearchParams(window.location.search);
        const proposerEmail = params.get('porposal-email');
        const notify = document.getElementById('notifyBtn');
        if(proposerEmail && notify){
          notify.style.display = 'inline-block';
          notify.addEventListener('click', function(){
            const subject = 'I said YES to your proposal! ðŸ’–';
            const body = 'Hello ' + (name||'') + ',\n\nI accepted your proposal. I said YES! ðŸŽ‰\n\nSee you soon â¤ï¸';
            const mailto = 'mailto:' + proposerEmail + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);

            // If site is hosted on GitHub Pages or opened via file://, PHP won't run â€” fall back to mailto
            if(window.location.protocol === 'file:' || (window.location.hostname && window.location.hostname.endsWith('github.io'))){
              window.location.href = mailto;
              return;
            }

            // otherwise try AJAX to server endpoint
            notify.disabled = true;
            notify.textContent = 'Notifying...';

            const form = new URLSearchParams();
            form.append('to', proposerEmail);
            form.append('subject', subject);
            form.append('message', body);

            fetch('send_mail.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
              body: form.toString()
            }).then(res=>{
              if(res.status === 405){
                // server does not allow POST (e.g., GitHub Pages) â€” fallback
                window.location.href = mailto;
                return Promise.reject(new Error('Server does not accept POST (405)'));
              }
              return res.json();
            }).then(json=>{
              if(json && json.ok){
                notify.textContent = 'Notified âœ“';
              } else {
                notify.textContent = 'Send failed';
                notify.disabled = false;
                alert('Notification failed: ' + (json && json.error ? json.error : 'unknown'));
              }
            }).catch(err=>{
              // fallback to mail client
              notify.textContent = 'Send failed';
              notify.disabled = false;
              try{ window.location.href = mailto; }catch(_){ }
            });
          });
        }
      }catch(e){}
    });
  </script>
</body>
</html>